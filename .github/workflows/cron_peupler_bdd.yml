# @format
name: "ğŸ•’ Cron - Peuplement automatique local"

on:
  schedule:
    - cron: "0 */3 * * *" # â° toutes les 6 heures (UTC)
  workflow_dispatch: {}     # âœ… dÃ©clenchement manuel
  push:
    branches: ["main"]      # âš™ï¸ optionnel : dÃ©clenche aussi sur push

permissions:
  contents: read

concurrency:
  group: cron-ingest
  cancel-in-progress: false

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      # ğŸ”¹ Variables issues des Secrets (ou du .secrets avec act)
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COMPETITIONS_API_URL: ${{ secrets.COMPETITIONS_API_URL }}
      TEAMS_API_URL: ${{ secrets.TEAMS_API_URL }}
      MATCHES_API_URL: ${{ secrets.MATCHES_API_URL }}

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§± Prisma generate
        run: npx prisma generate

      # ğŸ—‚ï¸ Force un chemin absolu pour SQLite et crÃ©e le dossier si besoin
      - name: ğŸ—‚ï¸ Set absolute DATABASE_URL and create folder
        shell: bash
        run: |
          set -Eeuo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/prisma"
          echo "DATABASE_URL=file:${GITHUB_WORKSPACE}/prisma/dev.db" >> "$GITHUB_ENV"
          echo "ğŸ“ Base de donnÃ©es : ${GITHUB_WORKSPACE}/prisma/dev.db"

      # ğŸ› ï¸ Remap endpoints pour act (container) : localhost -> host.docker.internal
      - name: ğŸ› ï¸ Remap endpoints for act (container)
        if: ${{ env.ACT == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "COMPETITIONS_API_URL=${COMPETITIONS_API_URL/localhost/host.docker.internal}" >> "$GITHUB_ENV"
          echo "TEAMS_API_URL=${TEAMS_API_URL/localhost/host.docker.internal}" >> "$GITHUB_ENV"
          echo "MATCHES_API_URL=${MATCHES_API_URL/localhost/host.docker.internal}" >> "$GITHUB_ENV"

      - name: ğŸ” Debug environment variables
        run: |
          echo "ğŸ”§ DATABASE_URL: $DATABASE_URL"
          echo "ğŸ”§ COMPETITIONS_API_URL: $COMPETITIONS_API_URL"
          echo "ğŸ”§ TEAMS_API_URL: $TEAMS_API_URL"
          echo "ğŸ”§ MATCHES_API_URL: $MATCHES_API_URL"

      # ğŸ—ƒï¸ CrÃ©e le fichier SQLite et pousse le schÃ©ma avant lâ€™ingestion
      - name: ğŸ—ƒï¸ Prisma db push (create schema)
        run: npx prisma db push

      # ğŸ›¡ï¸ Skip auto si URLs locales sur runner GitHub (non act)
      - name: ğŸ›¡ï¸ Guard: skip when localhost on GitHub-hosted
        if: ${{ env.ACT != 'true' && (contains(env.COMPETITIONS_API_URL, 'localhost') || contains(env.TEAMS_API_URL, 'localhost') || contains(env.MATCHES_API_URL, 'localhost')) }}
        run: |
          echo "âš ï¸ URLs locales dÃ©tectÃ©es (localhost). ExÃ©cution ignorÃ©e sur runner GitHub car les APIs locales ne sont pas joignables."
          exit 0

      # ğŸ” VÃ©rifie que les APIs externes rÃ©pondent avant ingestion
      - name: ğŸ” Ping APIs
        shell: bash
        run: |
          set -Eeuo pipefail
          curl --fail --max-time 8 -I "$COMPETITIONS_API_URL"
          curl --fail --max-time 8 -I "$TEAMS_API_URL"
          curl --fail --max-time 8 -I "$MATCHES_API_URL"

      - name: ğŸš€ Ingest competitions
        run: npm run ingest:competitions

      - name: ğŸš€ Ingest teams
        run: npm run ingest:teams

      - name: ğŸš€ Ingest matches
        run: npm run ingest:matches
