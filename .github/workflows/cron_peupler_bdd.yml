# @format
name: "ğŸ•’ Cron - Peuplement automatique (PostgreSQL)"

on:
  schedule:
    - cron: "0 */3 * * *" # â° toutes les 3 heures (UTC)
  workflow_dispatch: {}     # âœ… dÃ©clenchement manuel
  push:
    branches: ["main"]      # âš™ï¸ optionnel : dÃ©clenche aussi sur push

permissions:
  contents: read

concurrency:
  group: cron-ingest
  cancel-in-progress: false

jobs:
  ingest:
    runs-on: ubuntu-latest
    environment: DATABASE_CONFIG 

    env:
      # ğŸ”¹ Variables issues des Secrets
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COMPETITIONS_API_URL: ${{ secrets.COMPETITIONS_API_URL }}
      TEAMS_API_URL: ${{ secrets.TEAMS_API_URL }}
      MATCHES_API_URL: ${{ secrets.MATCHES_API_URL }}

    steps:
      - name: "ğŸ“¦ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ§° Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ§· Mirror POSTGRES_URL to DATABASE_URL (for Prisma directUrl)"
        run: |
          # Prisma lit directUrl=env("POSTGRES_URL") dans ton schema.
          # On le renseigne avec la mÃªme valeur que DATABASE_URL.
          echo "POSTGRES_URL=${DATABASE_URL}" >> "$GITHUB_ENV"

      - name: "ğŸ§± Prisma generate"
        run: npx prisma generate

      # ğŸ’¡ Si tu utilises des migrations, prÃ©fÃ¨re `migrate deploy`. Sinon garde `db push`.
      - name: "ğŸ—ƒï¸ Prisma migrate deploy (prod-safe)"
        run: npx prisma migrate deploy

      # - name: "ğŸ—ƒï¸ Prisma db push (schema sync sans migrations) â€” alternative"
      #   run: npx prisma db push

      - name: "ğŸ” Debug env (masked)"
        run: |
          echo "ğŸ”§ COMPETITIONS_API_URL: ${COMPETITIONS_API_URL}"
          echo "ğŸ”§ TEAMS_API_URL: ${TEAMS_API_URL}"
          echo "ğŸ”§ MATCHES_API_URL: ${MATCHES_API_URL}"

      # ğŸ›¡ï¸ Skip auto si URLs locales sur runner GitHub (non act)
      - name: "ğŸ›¡ï¸ Guard: skip when localhost on GitHub-hosted"
        if: ${{ env.ACT != 'true' && (contains(env.COMPETITIONS_API_URL, 'localhost') || contains(env.TEAMS_API_URL, 'localhost') || contains(env.MATCHES_API_URL, 'localhost')) }}
        run: |
          echo "âš ï¸ URLs locales dÃ©tectÃ©es (localhost). ExÃ©cution ignorÃ©e."
          exit 0

      # ğŸ” VÃ©rifie que les APIs externes rÃ©pondent avant ingestion
      - name: "ğŸ” Ping APIs"
        shell: bash
        run: |
          set -Eeuo pipefail
          curl --fail --max-time 8 -I "$COMPETITIONS_API_URL"
          curl --fail --max-time 8 -I "$TEAMS_API_URL"
          curl --fail --max-time 8 -I "$MATCHES_API_URL"

      - name: "ğŸš€ Ingest competitions"
        run: npm run ingest:competitions

      - name: "ğŸš€ Ingest teams"
        run: npm run ingest:teams

      - name: "ğŸš€ Ingest matches"
        run: npm run ingest:matches
