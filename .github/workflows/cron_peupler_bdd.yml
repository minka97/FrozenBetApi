# @format
name: "🕒 Cron - Peuplement automatique (PostgreSQL)"

on:
  schedule:
    - cron: "0 */3 * * *" # ⏰ toutes les 3 heures (UTC)
  workflow_dispatch: {}     # ✅ déclenchement manuel
  push:
    branches: ["main"]      # ⚙️ optionnel : déclenche aussi sur push

permissions:
  contents: read

concurrency:
  group: cron-ingest
  cancel-in-progress: false

jobs:
  ingest:
    runs-on: ubuntu-latest
    environment: DATABASE_CONFIG 

    env:
      # 🔹 Variables issues des Secrets
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      COMPETITIONS_API_URL: ${{ secrets.COMPETITIONS_API_URL }}
      TEAMS_API_URL: ${{ secrets.TEAMS_API_URL }}
      MATCHES_API_URL: ${{ secrets.MATCHES_API_URL }}

    steps:
      - name: "📦 Checkout repository"
        uses: actions/checkout@v4

      - name: "🧰 Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: "📦 Install dependencies"
        run: npm ci

      - name: "🧷 Mirror POSTGRES_URL to DATABASE_URL (for Prisma directUrl)"
        run: |
          # Prisma lit directUrl=env("POSTGRES_URL") dans ton schema.
          # On le renseigne avec la même valeur que DATABASE_URL.
          echo "POSTGRES_URL=${DATABASE_URL}" >> "$GITHUB_ENV"

      - name: "🧱 Prisma generate"
        run: npx prisma generate

      # 💡 Si tu utilises des migrations, préfère `migrate deploy`. Sinon garde `db push`.
      - name: "🗃️ Prisma migrate deploy (prod-safe)"
        run: npx prisma migrate deploy

      # - name: "🗃️ Prisma db push (schema sync sans migrations) — alternative"
      #   run: npx prisma db push

      - name: "🔎 Debug env (masked)"
        run: |
          echo "🔧 COMPETITIONS_API_URL: ${COMPETITIONS_API_URL}"
          echo "🔧 TEAMS_API_URL: ${TEAMS_API_URL}"
          echo "🔧 MATCHES_API_URL: ${MATCHES_API_URL}"

      # 🛡️ Skip auto si URLs locales sur runner GitHub (non act)
      - name: "🛡️ Guard: skip when localhost on GitHub-hosted"
        if: ${{ env.ACT != 'true' && (contains(env.COMPETITIONS_API_URL, 'localhost') || contains(env.TEAMS_API_URL, 'localhost') || contains(env.MATCHES_API_URL, 'localhost')) }}
        run: |
          echo "⚠️ URLs locales détectées (localhost). Exécution ignorée."
          exit 0

      # 🔍 Vérifie que les APIs externes répondent avant ingestion
      - name: "🔍 Ping APIs"
        shell: bash
        run: |
          set -Eeuo pipefail
          curl --fail --max-time 8 -I "$COMPETITIONS_API_URL"
          curl --fail --max-time 8 -I "$TEAMS_API_URL"
          curl --fail --max-time 8 -I "$MATCHES_API_URL"

      - name: "🚀 Ingest competitions"
        run: npm run ingest:competitions

      - name: "🚀 Ingest teams"
        run: npm run ingest:teams

      - name: "🚀 Ingest matches"
        run: npm run ingest:matches
